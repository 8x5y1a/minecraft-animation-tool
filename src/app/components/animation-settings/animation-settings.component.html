<div class="animation-tabs-wrapper">
  <mat-tab-group [selectedIndex]="tabIndex()">
    @for (properties of animationPropertiesList; track properties; let index =
    $index){
    <mat-tab [label]="'Animation ' + (index + 1)">
      <h3>Command</h3>
      <mat-chip-listbox [formControl]="properties.command" class="mb-1">
        <mat-chip-option value="set" selected>Set block</mat-chip-option>
        <mat-chip-option value="display">Display block</mat-chip-option>
        <mat-chip-option value="destroy">Destroy block</mat-chip-option>
      </mat-chip-listbox>

      <mat-divider />

      <div class="content">
        @if(properties.command.value === 'destroy'){
        <h3>Destroy</h3>
        <mat-form-field class="mb-1">
          <mat-label>Animation to destroy</mat-label>
          <mat-select [formControl]="properties.removeAnimation">
            @for (animation of animationPropertiesList; track animation) {
            @if(animation.command.value !== 'destroy'){
            <mat-option [value]="animation">{{ animation.name }}</mat-option>
            } }
          </mat-select>
        </mat-form-field>
        } @else{
        <mat-divider />
        <h3>Coordinates</h3>
        @if(properties.command.value ==='display'){
        <div class="mb-1">
          <mat-button-toggle-group [formControl]="properties.coordinateOption">
            <mat-button-toggle
              matTooltip="Building will stay at the same coordinates"
              [matTooltipDisabled]="preferenceService.isDisableTooltips"
              value="static"
              >Static Coordinates</mat-button-toggle
            >
            <mat-button-toggle
              matTooltip="Building will translate to new coordinates"
              [matTooltipDisabled]="preferenceService.isDisableTooltips"
              value="gradual"
              >Gradual Coordinates</mat-button-toggle
            >
          </mat-button-toggle-group>
        </div>
        }
        <div class="coordinates mb-1">
          <div
            matTooltip="Coordinates which the building will be built"
            [matTooltipDisabled]="preferenceService.isDisableTooltips"
          >
            @if(properties.coordinateOption.value === 'gradual'){
            <b>Initial: </b>
            }
            <mat-form-field>
              <mat-label>X</mat-label>
              <input type="number" matInput [formControl]="properties.x" />
            </mat-form-field>
            <mat-form-field>
              <mat-label>Y</mat-label>
              <input type="number" matInput [formControl]="properties.y" />
            </mat-form-field>
            <mat-form-field>
              <mat-label>Z</mat-label>
              <input type="number" matInput [formControl]="properties.z" />
            </mat-form-field>
          </div>

          @if(properties.coordinateOption.value === 'gradual' &&
          properties.command.value === 'display'){
          <div
            matTooltip="Coordinates which the building will be moved to"
            [matTooltipDisabled]="preferenceService.isDisableTooltips"
          >
            <b>Final: </b>
            <mat-form-field>
              <mat-label>X</mat-label>
              <input type="number" matInput [formControl]="properties.endX" />
            </mat-form-field>
            <mat-form-field>
              <mat-label>Y</mat-label>
              <input type="number" matInput [formControl]="properties.endY" />
            </mat-form-field>
            <mat-form-field>
              <mat-label>Z</mat-label>
              <input type="number" matInput [formControl]="properties.endZ" />
            </mat-form-field>
          </div>
          }
        </div>
        }

        <mat-divider />
        <div class="center">
          <h3 [className]="properties.timing.value ? 'disabled' : ''">
            Animation settings
          </h3>
          <mat-slide-toggle
            [formControl]="properties.timing"
            matTooltip="When on: the build will animate in gradually | When off: it appears instantly"
            [matTooltipDisabled]="preferenceService.isDisableTooltips"
          >
            Enable Animation
          </mat-slide-toggle>
        </div>

        @if(properties.timing.value){
        <div class="center" style="display: flex">
          <mat-card-content>
            <mat-form-field>
              <mat-label>Animation speed</mat-label>
              <input
                matInput
                matTooltip="Higher value is slower"
                [matTooltipDisabled]="preferenceService.isDisableTooltips"
                type="number"
                [min]="1"
                [max]="500"
                [formControl]="properties.speed"
              />
            </mat-form-field>
          </mat-card-content>

          <mat-form-field>
            <mat-label>Animation order</mat-label>
            <mat-select [formControl]="properties.animationOrder">
              <mat-option value="x">X</mat-option>
              <mat-option value="y">Y</mat-option>
              <mat-option value="z">Z</mat-option>
              <mat-option value="random">Random</mat-option>
            </mat-select>
          </mat-form-field>

          @if(properties.animationOrder.value !== 'random'){
          <mat-slide-toggle
            [formControl]="properties.isAscending"
            matTooltip="Should it Start from the smallest value and end with the highest value"
            [matTooltipDisabled]="preferenceService.isDisableTooltips"
          >
            Ascending order
          </mat-slide-toggle>
          <div
            matTooltip="Add a level of randomness to the current animation order. (0: No randomness)"
            [matTooltipDisabled]="preferenceService.isDisableTooltips"
          >
            <div class="randomness-label-container">
              <label for="slider">Randomness: </label>
              <label for="slider"> {{ properties.randomness.value }}</label>
            </div>
            <mat-slider [max]="10" [min]="0" [step]="1">
              <input
                [formControl]="properties.randomness"
                matSliderThumb
                id="slider"
              />
            </mat-slider>
          </div>
          }
        </div>
        } @if(displayScaling(properties)){
        <mat-divider />
        <h3>Scaling</h3>
        @if(properties.command.value === 'display'){
        <div class="mb-1">
          <mat-button-toggle-group [formControl]="properties.scaleOption">
            <mat-button-toggle
              matTooltip="Scale will stay the same size"
              value="static"
              [matTooltipDisabled]="preferenceService.isDisableTooltips"
              >Static Scale</mat-button-toggle
            >
            <mat-button-toggle
              matTooltip="Scale will gradually change during the animation"
              [matTooltipDisabled]="preferenceService.isDisableTooltips"
              value="gradual"
              >Gradual Scale</mat-button-toggle
            >
          </mat-button-toggle-group>
        </div>
        }
        <div class="mb-1">
          @if(properties.scaleOption.value === 'static' &&
          properties.command.value === 'display'){
          <mat-form-field>
            <input
              matInput
              type="number"
              [formControl]="properties.staticScale"
              min="0.001"
            />
            <mat-label>Scaling</mat-label>
          </mat-form-field>
          } @else {
          <ng-container
            *ngTemplateOutlet="
              gradualScale;
              context: { properties: properties }
            "
          ></ng-container>
          }
        </div>
        } @if(animationPropertiesList.length > 1){
        <mat-divider />
        <h3>Transition</h3>

        <mat-form-field
          class="mb-1"
          matTooltip="Animation that will start after this one ends. Leave empty if you don't want any animation to play after."
          [matTooltipDisabled]="preferenceService.isDisableTooltips"
        >
          <mat-label>Animation to play after</mat-label>
          <mat-select [formControl]="properties.nextAnimation">
            @for (animation of animationPropertiesList; track animation) {
            <mat-option [value]="animation">{{ animation.name }}</mat-option>
            }
          </mat-select>
        </mat-form-field>
        }
      </div>
      <!-- TODO: Footer style -->
      <div class="footer">
        @if(properties.command.value !== 'destroy'){
        <button
          mat-button
          matTooltip="Add a destroy animation for this animation"
          [matTooltipDisabled]="preferenceService.isDisableTooltips"
          (click)="addDestroyAnimation(properties)"
        >
          Add destroy for this animation
        </button>
        } @if(animationPropertiesList.length > 1){
        <button
          mat-button
          matTooltip="Remove this animation"
          [matTooltipDisabled]="preferenceService.isDisableTooltips"
          (click)="removeAnimation(index)"
        >
          Remove
        </button>
        }
      </div>
    </mat-tab>
    }
  </mat-tab-group>
  <button
    mat-flat-button
    matTooltip="Add another animation"
    [matTooltipDisabled]="preferenceService.isDisableTooltips"
    class="add-animation-btn"
    (click)="openAddDialog()"
  >
    <mat-icon style="margin: 0">add</mat-icon>
  </button>
</div>

<ng-template #dialogAdd let-data>
  <h2 mat-dialog-title>Add animation</h2>
  <mat-dialog-content>
    @if(!isAddTemplate){
    <button mat-flat-button mat-dialog-close (click)="addAnimation()">
      Add custom animation
    </button>
    <button
      style="margin-left: 10px"
      mat-flat-button
      (click)="isAddTemplate = true"
    >
      Add from templates
    </button>
    } @else {
    <app-template-list (templateEmit)="addTemplate($event)" />
    }
  </mat-dialog-content>
  <mat-dialog-actions>
    <button mat-button mat-dialog-close>Cancel</button>
  </mat-dialog-actions>
</ng-template>

<ng-template #gradualScale let-properties="properties">
  <div class="center">
    <mat-form-field>
      <input
        matInput
        type="number"
        [formControl]="properties.gradualScaleStart"
        min="0"
      />
      <mat-label>Start Scale</mat-label>
    </mat-form-field>
    <mat-form-field>
      <input
        matInput
        type="number"
        [formControl]="properties.gradualScaleEnd"
        min="0"
      />
      <mat-label>End Scale</mat-label>
    </mat-form-field>
    <div
      matTooltip="Speed at which the scale will change"
      [matTooltipDisabled]="preferenceService.isDisableTooltips"
    >
      <div class="randomness-label-container">
        <label for="slider">Scale time: </label>
        <label for="slider"> {{ properties.scaleSpeed.value }}</label>
      </div>
      <mat-slider [max]="100" [min]="1" [step]="1">
        <input
          [formControl]="properties.scaleSpeed"
          matSliderThumb
          id="slider"
        />
      </mat-slider>
    </div>
  </div>
</ng-template>
